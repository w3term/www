# .gitlab-ci.yml
stages:
  - release
  - build-prod
  - deploy
  - publish

# New release tag only created when commit done on main branch
release:
  image: node:20
  stage: release
  before_script:
    - git config --global user.email "devops@exoscale.dev"
    - git config --global user.name "GitLab CI"
  script:
    - touch CHANGELOG.md
    - npm install @semantic-release/gitlab @semantic-release/exec @semantic-release/changelog @semantic-release/git
    - npx semantic-release
  artifacts:
    paths:
      - CHANGELOG.md
  only:
    - main

# Build production version on each new tag (created by semantic-release)
build-production:
  stage: build-prod
  image: node:20-alpine
  before_script:
    - npm install -g terser
    - mkdir -p dist
  script:
    - echo "Building production version $CI_COMMIT_TAG"
    # Create JS file with header
    - echo "/**" > dist/terminal.js
    - echo " * Web Terminal Embed" >> dist/terminal.js
    - echo " * Version $CI_COMMIT_TAG" >> dist/terminal.js
    - echo " * Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/terminal.js
    - echo " * Commit ${CI_COMMIT_SHA}" >> dist/terminal.js
    - echo " * Release Tag ${CI_COMMIT_TAG}" >> dist/terminal.js
    - echo " */" >> dist/terminal.js
    - cat terminal.js >> dist/terminal.js
    # Minify
    - terser dist/terminal.js --compress --mangle --output dist/terminal.min.js --comments "/^!|@preserve|@license|@cc_on/i"
    - ls dist
    # Create VERSION.txt
    - echo "Version $CI_COMMIT_TAG" > dist/VERSION.txt
    - echo "Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/VERSION.txt
    - echo "Commit ${CI_COMMIT_SHA}" >> dist/VERSION.txt
    - echo "Release Tag ${CI_COMMIT_TAG}" >> dist/VERSION.txt
    # Copy index.html
    - cp index.html dist/index.html
    # Prepare for GitLab Pages and npm publishing
    - mkdir -p public
    - cp -r dist/* public/
  artifacts:
    paths:
      - public/
      - dist/
  only:
    - tags

# Deploy to GitLab Pages - this job name MUST be 'pages'
pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages"
    - ls -la public/ || echo "No public directory found"
  artifacts:
    paths:
      - public
  only:
    - tags

# Publish production releases to npm for automatic jsDelivr availability
publish-npm:
  stage: publish
  image: node:20-alpine
  before_script:
    - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
    - npm config set registry https://registry.npmjs.org/
    # Copy files from dist to root for npm publish
    - cp dist/terminal.js ./
    - cp dist/terminal.min.js ./
    - cp dist/VERSION.txt ./ 
  script:
    - echo "Publishing production version $CI_COMMIT_TAG to npm"
    - npm version $CI_COMMIT_TAG --no-git-tag-version --allow-same-version
    - ls -al
    - echo "Files to be published:"
    - cat package.json | grep -A 10 '"files"'
    - npm publish --access public
    - echo "Production package published successfully!"
    - echo "Available at https://www.npmjs.com/package/@web-terminal/terminal"
    - echo "jsDelivr CDN URLs:"
    - echo "https://cdn.jsdelivr.net/npm/@web-terminal/terminal@$CI_COMMIT_TAG/terminal.min.js"
    - echo "https://cdn.jsdelivr.net/npm/@web-terminal/terminal@latest/terminal.min.js"
  dependencies:
    - build-production
  only:
    - tags