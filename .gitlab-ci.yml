# .gitlab-ci.yml
stages:
  - build-dev
  - release
  - build-prod
  - deploy
  - publish

# Build development version when push on develop branch
build-dev:
  stage: build-dev
  image: node:18-alpine
  before_script:
    - npm install -g terser
    - mkdir -p dist
  script:
    - DEV_VERSION="develop-${CI_COMMIT_SHORT_SHA}"
    - echo "Building development version $DEV_VERSION"
    # Create JS file with header
    - echo "/**" > dist/terminal.js
    - echo " * Web Terminal Embed" >> dist/terminal.js
    - echo " * Version $DEV_VERSION" >> dist/terminal.js
    - echo " * Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/terminal.js
    - echo " * Commit ${CI_COMMIT_SHA}" >> dist/terminal.js
    - echo " * Branch ${CI_COMMIT_REF_NAME}" >> dist/terminal.js
    - echo " */" >> dist/terminal.js
    - cat terminal.js >> dist/terminal.js
    # Minify
    - terser dist/terminal.js --compress --mangle --output dist/terminal.min.js --comments "/^!|@preserve|@license|@cc_on/i"
    # Create VERSION.txt
    - echo "Version $DEV_VERSION" > dist/VERSION.txt
    - echo "Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/VERSION.txt
    - echo "Commit ${CI_COMMIT_SHA}" >> dist/VERSION.txt
    - echo "Branch ${CI_COMMIT_REF_NAME}" >> dist/VERSION.txt
    - echo "Environment Development" >> dist/VERSION.txt
    # Copy demo.html and replace placeholders for development
    - cp demo.html dist/index.html
    - sed -i "s/{{VERSION}}/$DEV_VERSION/g" dist/index.html
    - sed -i "s/{{ENVIRONMENT}}/Development/g" dist/index.html
    - sed -i "s/{{BRANCH}}/${CI_COMMIT_REF_NAME}/g" dist/index.html
    - sed -i "s/{{COMMIT}}/${CI_COMMIT_SHORT_SHA}/g" dist/index.html
    - sed -i "s/{{BUILD_DATE}}/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/g" dist/index.html
    - sed -i "s/{{NAMESPACE}}/${CI_PROJECT_NAMESPACE}/g" dist/index.html
    - sed -i "s/{{PROJECT}}/${CI_PROJECT_NAME}/g" dist/index.html
    - sed -i "s/{{IS_PRODUCTION}}/false/g" dist/index.html
    - sed -i "s/{{CDN_TAG}}/develop/g" dist/index.html
    # Prepare for GitLab Pages only
    - mkdir -p public/develop
    - cp -r dist/* public/develop/
  artifacts:
    paths:
      - public/
      - dist/
    expire_in: 7 days
  only:
    - develop

# New release tag only created when commit done on main branch
release:
  image: node:20
  stage: release
  before_script:
    - git config --global user.email "gitlab-ci@yourdomain.com"
    - git config --global user.name "GitLab CI"
  script:
    - touch CHANGELOG.md
    - npm install @semantic-release/gitlab @semantic-release/exec @semantic-release/changelog @semantic-release/git
    - npx semantic-release
  artifacts:
    paths:
      - CHANGELOG.md
  only:
    - main

# Build production version on each new tag (created by semantic-release)
build-production:
  stage: build-prod
  image: node:18-alpine
  before_script:
    - npm install -g terser
    - mkdir -p dist
  script:
    - PROD_VERSION="$CI_COMMIT_TAG"
    - echo "Building production version $PROD_VERSION"
    # Create JS file with header
    - echo "/**" > dist/terminal.js
    - echo " * Web Terminal Embed" >> dist/terminal.js
    - echo " * Version $PROD_VERSION" >> dist/terminal.js
    - echo " * Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/terminal.js
    - echo " * Commit ${CI_COMMIT_SHA}" >> dist/terminal.js
    - echo " * Release Tag ${CI_COMMIT_TAG}" >> dist/terminal.js
    - echo " */" >> dist/terminal.js
    - cat terminal.js >> dist/terminal.js
    # Minify
    - terser dist/terminal.js --compress --mangle --output dist/terminal.min.js --comments "/^!|@preserve|@license|@cc_on/i"
    # Create VERSION.txt
    - echo "Version $PROD_VERSION" > dist/VERSION.txt
    - echo "Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/VERSION.txt
    - echo "Commit ${CI_COMMIT_SHA}" >> dist/VERSION.txt
    - echo "Release Tag ${CI_COMMIT_TAG}" >> dist/VERSION.txt
    - echo "Environment Production" >> dist/VERSION.txt
    # Copy demo.html and replace placeholders for production
    - cp demo.html dist/index.html
    - sed -i "s/{{VERSION}}/$PROD_VERSION/g" dist/index.html
    - sed -i "s/{{ENVIRONMENT}}/Production/g" dist/index.html
    - sed -i "s/{{BRANCH}}/main/g" dist/index.html
    - sed -i "s/{{COMMIT}}/${CI_COMMIT_SHORT_SHA}/g" dist/index.html
    - sed -i "s/{{BUILD_DATE}}/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/g" dist/index.html
    - sed -i "s/{{NAMESPACE}}/${CI_PROJECT_NAMESPACE}/g" dist/index.html
    - sed -i "s/{{PROJECT}}/${CI_PROJECT_NAME}/g" dist/index.html
    - sed -i "s/{{IS_PRODUCTION}}/true/g" dist/index.html
    - sed -i "s/{{CDN_TAG}}/latest/g" dist/index.html
    # Prepare for GitLab Pages and npm publishing
    - mkdir -p public
    - cp -r dist/* public/
    # Copy built files to root for npm publishing
    - cp dist/terminal.js ./
    - cp dist/terminal.min.js ./
    - cp dist/VERSION.txt ./
    - cp dist/index.html ./
  artifacts:
    paths:
      - public/
      - dist/
      - terminal.js
      - terminal.min.js
      - VERSION.txt
      - index.html
    expire_in: 30 days
  only:
    - tags

# Deploy to GitLab Pages - this job name MUST be 'pages'
pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages"
    - ls -la public/ || echo "No public directory found"
  artifacts:
    paths:
      - public
  only:
    - develop
    - tags

# Publish production releases to npm for automatic jsDelivr availability
publish-npm:
  stage: publish
  image: node:18-alpine
  before_script:
    - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
    - npm config set registry https://registry.npmjs.org/
  script:
    - echo "Publishing production version $CI_COMMIT_TAG to npm"
    - npm version $CI_COMMIT_TAG --no-git-tag-version --allow-same-version
    - ls -la terminal.min.js terminal.js
    - echo "Files to be published:"
    - cat package.json | grep -A 10 '"files"'
    - npm publish --access public
    - echo "Production package published successfully!"
  dependencies:
    - build-production
  only:
    - tags