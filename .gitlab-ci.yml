# .gitlab-ci.yml
stages:
  - build-dev
  - release
  - build-prod

# Build development version when push on develop branch
build-dev:
  stage: build-dev
  image: node:18-alpine
  script:
    - npm install -g terser
    - mkdir -p dist
    - DEV_VERSION="develop-${CI_COMMIT_SHORT_SHA}"
    - echo "Building development version $DEV_VERSION"
    - echo "/**" > dist/web-terminal-embed.js
    - echo " * Web Terminal Embed" >> dist/web-terminal-embed.js
    - echo " * Version $DEV_VERSION" >> dist/web-terminal-embed.js
    - echo " * Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/web-terminal-embed.js
    - echo " * Commit ${CI_COMMIT_SHA}" >> dist/web-terminal-embed.js
    - echo " * Branch ${CI_COMMIT_REF_NAME}" >> dist/web-terminal-embed.js
    - echo " */" >> dist/web-terminal-embed.js
    - cat web-terminal.js >> dist/web-terminal-embed.js
    - terser dist/web-terminal-embed.js --compress --mangle --output dist/web-terminal-embed.min.js --comments "/^!|@preserve|@license|@cc_on/i"
    - echo "Version $DEV_VERSION" > dist/VERSION.txt
    - echo "Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/VERSION.txt
    - echo "Commit ${CI_COMMIT_SHA}" >> dist/VERSION.txt
    - echo "Branch ${CI_COMMIT_REF_NAME}" >> dist/VERSION.txt
    - echo "Environment Development" >> dist/VERSION.txt
    - mkdir -p public/develop
    - cp -r dist/* public/develop/
  artifacts:
    paths:
      - public/
    expire_in: 7 days
  only:
    - develop

# New release tag only created when commit done on main branch
release:
  image: node:20
  stage: release
  before_script:
    - git config --global user.email "gitlab-ci@yourdomain.com"
    - git config --global user.name "GitLab CI"
  script:
    - touch CHANGELOG.md
    - npm install @semantic-release/gitlab @semantic-release/exec @semantic-release/changelog @semantic-release/git
    - npx semantic-release
  artifacts:
    paths:
      - CHANGELOG.md
  only:
    - main

# Build production version on each new tag (created by semantic-release)
build-production:
  stage: build-prod
  image: node:18-alpine
  script:
    - npm install -g terser
    - mkdir -p dist
    - PROD_VERSION="$CI_COMMIT_TAG"
    - echo "Building production version $PROD_VERSION"
    - echo "/**" > dist/web-terminal-embed.js
    - echo " * Web Terminal Embed" >> dist/web-terminal-embed.js
    - echo " * Version $PROD_VERSION" >> dist/web-terminal-embed.js
    - echo " * Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/web-terminal-embed.js
    - echo " * Commit ${CI_COMMIT_SHA}" >> dist/web-terminal-embed.js
    - echo " * Release Tag ${CI_COMMIT_TAG}" >> dist/web-terminal-embed.js
    - echo " */" >> dist/web-terminal-embed.js
    - cat web-terminal.js >> dist/web-terminal-embed.js
    - terser dist/web-terminal-embed.js --compress --mangle --output dist/web-terminal-embed.min.js --comments "/^!|@preserve|@license|@cc_on/i"
    - echo "Version $PROD_VERSION" > dist/VERSION.txt
    - echo "Build Date $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dist/VERSION.txt
    - echo "Commit ${CI_COMMIT_SHA}" >> dist/VERSION.txt
    - echo "Release Tag ${CI_COMMIT_TAG}" >> dist/VERSION.txt
    - echo "Environment Production" >> dist/VERSION.txt
    - echo '<!DOCTYPE html>' > dist/index.html
    - echo '<html><head><title>Web Terminal Embed CDN</title></head>' >> dist/index.html
    - echo '<body><h1>Web Terminal Embed CDN</h1>' >> dist/index.html
    - echo '<h2>Production Release</h2>' >> dist/index.html
    - echo "<p><strong>Version:</strong> $PROD_VERSION</p>" >> dist/index.html
    - echo "<p><strong>Built:</strong> $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>" >> dist/index.html
    - echo '<h3>CDN URLs</h3>' >> dist/index.html
    - echo '<p><code>https://cdn.jsdelivr.net/gl/'${CI_PROJECT_NAMESPACE}'/'${CI_PROJECT_NAME}'@latest/dist/web-terminal-embed.min.js</code></p>' >> dist/index.html
    - echo '<p><code>https://cdn.jsdelivr.net/gl/'${CI_PROJECT_NAMESPACE}'/'${CI_PROJECT_NAME}'@'$PROD_VERSION'/dist/web-terminal-embed.min.js</code></p>' >> dist/index.html
    - echo '<h3>Usage</h3>' >> dist/index.html
    - echo '<pre>&lt;script src="https://cdn.jsdelivr.net/gl/'${CI_PROJECT_NAMESPACE}'/'${CI_PROJECT_NAME}'@latest/dist/web-terminal-embed.min.js"&gt;&lt;/script&gt;</pre>' >> dist/index.html
    - echo '<h3>Files</h3>' >> dist/index.html
    - echo '<ul>' >> dist/index.html
    - echo '<li><a href="web-terminal-embed.min.js">web-terminal-embed.min.js</a></li>' >> dist/index.html
    - echo '<li><a href="web-terminal-embed.js">web-terminal-embed.js</a></li>' >> dist/index.html
    - echo '<li><a href="VERSION.txt">VERSION.txt</a></li>' >> dist/index.html
    - echo '</ul></body></html>' >> dist/index.html
    - mkdir -p public
    - cp -r dist/* public/
  artifacts:
    paths:
      - public/
    expire_in: 30 days
  only:
    - tags<a href="web-terminal-embed.min.js">web-terminal-embed.min.js</a> (production build)</li>
              <li><a href="web-terminal-embed.js">web-terminal-embed.js</a> (source with comments)</li>
              <li><a href="VERSION.txt">VERSION.txt</a> (build information)</li>
              <li><a href="package.json">package.json</a> (package metadata)</li>
          </ul>
          
          <h2>üìä Version Information</h2>
          <ul>
              <li><strong>Version:</strong> ${CI_COMMIT_TAG}</li>
              <li><strong>Built:</strong> $(date -u +"%Y-%m-%d %H:%M:%S UTC")</li>
              <li><strong>Commit:</strong> ${CI_COMMIT_SHORT_SHA}</li>
          </ul>
      </body>
      </html>
      EOF
    
    # Replace placeholders in the HTML
    - sed -i "s/\${CI_COMMIT_TAG}/$CI_COMMIT_TAG/g" dist/index.html
    - sed -i "s/\${CI_PROJECT_NAMESPACE}/$CI_PROJECT_NAMESPACE/g" dist/index.html
    - sed -i "s/\${CI_PROJECT_NAME}/$CI_PROJECT_NAME/g" dist/index.html
    - sed -i "s/\${CI_COMMIT_SHORT_SHA}/$CI_COMMIT_SHORT_SHA/g" dist/index.html
    
    # Add demo JavaScript to the HTML
    - |
      cat >> dist/index.html << 'EOF'
      <script src="web-terminal-embed.min.js"></script>
      <script>
          let currentTerminal = null;
          
          function initTerminal() {
              const appName = document.getElementById('appName').value.trim();
              const clientId = document.getElementById('clientId').value.trim();
              const domain = document.getElementById('domain').value.trim();
              const status = document.getElementById('status');
              
              if (!appName || !clientId) {
                  status.style.display = 'block';
                  status.style.background = '#f8d7da';
                  status.style.color = '#721c24';
                  status.textContent = 'Please fill in GitHub App Name and Client ID';
                  return;
              }
              
              try {
                  if (currentTerminal && typeof currentTerminal.destroy === 'function') {
                      currentTerminal.destroy();
                  }
                  
                  const config = {
                      githubAppName: appName,
                      githubClientId: clientId
                  };
                  
                  if (domain) {
                      config.backendDomain = domain;
                  }
                  
                  currentTerminal = new WebTerminalEmbed(config);
                  
                  status.style.display = 'block';
                  status.style.background = '#d4edda';
                  status.style.color = '#155724';
                  status.textContent = '‚úÖ Terminal initialized! Look for the ">_" button in the bottom-right corner.';
                  
              } catch (error) {
                  status.style.display = 'block';
                  status.style.background = '#f8d7da';
                  status.style.color = '#721c24';
                  status.textContent = '‚ùå Error: ' + error.message;
              }
          }
      </script>
      </html>
      EOF
    
    # Deploy production version to GitLab Pages root
    - mkdir -p public
    - cp -r dist/* public/
  artifacts:
    paths:
      - public/
    expire_in: 30 days
  only:
    - tags